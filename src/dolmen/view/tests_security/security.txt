Security
========

  >>> import dolmen.view as dolmen
  >>> from grokcore.security import require
  >>> from cromlech.browser.testing import TestResponse, TestRequest
  >>> from grokcore.component import testing

  >>> class Mammoth(dolmen.Context):
  ...     pass


  >>> class Public(dolmen.View):
  ...    dolmen.context(Mammoth)
  ...    require('zope.View')
  ...
  ...    responseFactory = TestResponse
  ...
  ...    def render(self, *args, **kwargs):
  ...        return u"Shaven mammoth !! YUCK"

  >>> testing.grok_component('nude', Public)
  True


  >>> class Private(dolmen.View):
  ...    dolmen.context(Mammoth)
  ...    require('zope.ManageContent')
  ...
  ...    responseFactory = TestResponse
  ...
  ...    def render(self, *args, **kwargs):
  ...        return u"Hairy mammoth won't shave in public !"

  >>> testing.grok_component('prude', Private)
  True

  >>> context = Mammoth()
  >>> request = TestRequest()


Security declaration
--------------------

  >>> from zope.security.proxy import ProxyFactory
  >>> from zope.security.management import newInteraction, endInteraction
  >>> from zope.security.testing import Principal, Participation


Security policy
~~~~~~~~~~~~~~~

  >>> from zope.security.simplepolicies import ParanoidSecurityPolicy
  >>> from zope.security.management import setSecurityPolicy

  >>> class TestPolicy(ParanoidSecurityPolicy):
  ...
  ...     def checkPermission(self, permission, object):
  ...         if permission == "zope.Public":
  ...             return True
  ...
  ...         for p in self.participations:
  ...	          if (permission == 'zope.View' and
  ...                 p.principal.id == 'cromlech.user'):
  ...                 return True
  ...
  ...         return False
  
  >>> from zope.security.management import setSecurityPolicy, getSecurityPolicy
  >>> assert setSecurityPolicy(TestPolicy)
  >>> assert getSecurityPolicy() == TestPolicy


Allowed
~~~~~~~

  >>> newInteraction(Participation(Principal('cromlech.user')))

  >>> view = dolmen.query_view(request, context, name='public')
  >>> proxy = ProxyFactory(view)
  >>> proxy.render()
  u'Shaven mammoth !! YUCK'
  >>> proxy()
  <cromlech.browser.testing.TestResponse object at ...>


Disallowed
~~~~~~~~~~

  >>> view = dolmen.query_view(request, context, name='private')
  >>> ProxyFactory(view).render()
  Traceback (most recent call last):
  ...
  Unauthorized: (<Private object at ...>, 'render', 'zope.ManageContent')

  >>> endInteraction()
